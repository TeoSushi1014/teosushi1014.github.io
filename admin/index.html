<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Tèo Sushi - Admin Dashboard</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .admin-form {
            max-width: 600px;
            margin: 20px auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group textarea:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 2px rgba(135, 206, 235, 0.2);
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: var(--primary-blue);
            color: white;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn:hover {
            background: var(--primary-pink);
        }
        .projects-list {
            margin-top: 30px;
        }
        .project-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--glass-bg);
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }
        .project-item:hover {
            transform: translateX(5px);
            border-color: var(--primary-pink);
        }
        .project-info {
            flex: 1;
        }
        .project-info h3 {
            color: var(--text-color);
            margin-bottom: 5px;
        }
        .project-info p {
            color: var(--text-color);
            opacity: 0.8;
        }
        .delete-btn {
            background: #ff6b6b;
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        .delete-btn:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        .nav-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .logout-btn {
            background: #ff6b6b;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }

        .user-info svg {
            width: 20px;
            height: 20px;
        }

        /* Loading spinner */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--glass-bg);
            border-top: 5px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .char-count {
            float: right;
            font-size: 0.8em;
            color: var(--text-color);
            opacity: 0.7;
        }

        .tech-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .tech-tag {
            background: var(--primary-blue);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: var(--text-color);
            opacity: 0.7;
        }

        .error-message {
            color: #ff6b6b;
            font-size: 0.9em;
            margin-top: 5px;
            animation: fadeIn 0.3s ease;
        }

        .invalid-input {
            border-color: #ff6b6b !important;
        }
    </style>
</head>
<body>
    <nav class="glass-nav">
        <div class="nav-content">
            <h1 class="gradient-text">Tèo Sushi Admin</h1>
            <div class="nav-actions">
                <div class="user-info">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span id="userDisplay"></span>
                </div>
                <button onclick="logout()" class="btn logout-btn">Logout</button>
                <a href="../index.html" class="btn">Back to Portfolio</a>
            </div>
        </div>
    </nav>

    <main>
        <section class="glass-section">
            <h2>Add New Project</h2>
            <form id="projectForm" class="admin-form">
                <div class="form-group">
                    <label for="title">Project Title</label>
                    <input type="text" id="title" required 
                           minlength="3" 
                           placeholder="Enter project title"
                           pattern="^[a-zA-Z0-9\s\-_]+$"
                           title="Title can only contain letters, numbers, spaces, hyphens and underscores">
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" required 
                            minlength="10" 
                            maxlength="500"
                            placeholder="Describe your project (10-500 characters)"
                            rows="4"></textarea>
                    <small class="char-count">0/500</small>
                </div>
                <div class="form-group">
                    <label for="technologies">Technologies (comma separated)</label>
                    <input type="text" id="technologies" 
                           required
                           placeholder="e.g., HTML, CSS, JavaScript"
                           pattern="^[a-zA-Z0-9\s\-_+#,\.]+$"
                           title="Enter technologies separated by commas">
                    <small class="tech-preview"></small>
                </div>
                <div class="form-group">
                    <label for="link">Project Link</label>
                    <input type="url" id="link" required
                           placeholder="https://example.com"
                           pattern="https?://.+"
                           title="Include http:// or https:// in the URL">
                </div>
                <button type="submit" class="btn">Add Project</button>
            </form>
        </section>

        <section class="glass-section">
            <h2>Manage Projects</h2>
            <div id="projectsList" class="projects-list"></div>
        </section>
    </main>

    <div class="loading" id="loadingSpinner">
        <div class="spinner"></div>
    </div>

    <script>
        // Hàm mã hóa password với SHA-256
        async function hashPassword(password, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + salt);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // Salt và thông tin xác thực
        const SALT = "p8K#mN2$qL9*vX5";
        const ADMIN_USERNAME = "teosushi-admin";
        const HASHED_PASSWORD = "c1b5b1c5c818c5947784778e88f3b8167d6e6d6d6e75325e4bdc742049d0b7ba";

        // Kiểm tra authentication
        if (!localStorage.getItem('isAdmin')) {
            const username = prompt('Enter username:');
            if (username === ADMIN_USERNAME) {
                const password = prompt('Enter password:');
                // Mã hóa password người dùng nhập vào
                hashPassword(password, SALT).then(hashedInput => {
                    if (hashedInput === HASHED_PASSWORD) {
                        localStorage.setItem('isAdmin', 'true');
                        localStorage.setItem('lastLogin', new Date().toISOString());
                        localStorage.setItem('adminUsername', username);
                    } else {
                        alert('Invalid credentials');
                        window.location.href = '../index.html';
                    }
                });
            } else {
                alert('Invalid credentials');
                window.location.href = '../index.html';
            }
        }

        // Hiển thị thông tin người dùng đã đăng nhập
        const username = localStorage.getItem('adminUsername');
        if (username) {
            document.getElementById('userDisplay').textContent = username;
        }

        // Kiểm tra thời gian đăng nhập
        const lastLogin = localStorage.getItem('lastLogin');
        if (lastLogin) {
            const loginTime = new Date(lastLogin);
            const now = new Date();
            const hoursSinceLogin = (now - loginTime) / (1000 * 60 * 60);
            
            // Tự động đăng xuất sau 24 giờ
            if (hoursSinceLogin > 24) {
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('lastLogin');
                window.location.reload();
            }
        }

        const projectForm = document.getElementById('projectForm');
        const projectsList = document.getElementById('projectsList');

        function loadProjects() {
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            projectsList.innerHTML = projects.map(project => `
                <div class="project-item">
                    <div class="project-info">
                        <h3>${project.title}</h3>
                        <p>${project.description}</p>
                    </div>
                    <button class="btn delete-btn" onclick="deleteProject(${project.id})">Delete</button>
                </div>
            `).join('');
        }

        projectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Reset previous error states
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            document.querySelectorAll('.invalid-input').forEach(el => el.classList.remove('invalid-input'));
            
            let isValid = true;
            const errors = {};

            // Validate title
            const title = document.getElementById('title');
            if (title.value.length < 3) {
                errors.title = 'Title must be at least 3 characters long';
                isValid = false;
            }

            // Validate description
            const description = document.getElementById('description');
            if (description.value.length < 10) {
                errors.description = 'Description must be at least 10 characters long';
                isValid = false;
            }

            // Validate technologies
            const techInput = document.getElementById('technologies');
            const techs = techInput.value.split(',').map(t => t.trim()).filter(t => t);
            if (techs.length === 0) {
                errors.technologies = 'At least one technology is required';
                isValid = false;
            }

            // Validate URL
            const link = document.getElementById('link');
            try {
                new URL(link.value);
            } catch {
                errors.link = 'Please enter a valid URL';
                isValid = false;
            }

            // Show errors if any
            if (!isValid) {
                Object.entries(errors).forEach(([field, message]) => {
                    const input = document.getElementById(field);
                    input.classList.add('invalid-input');
                    const error = document.createElement('div');
                    error.className = 'error-message';
                    error.textContent = message;
                    input.parentNode.appendChild(error);
                });
                return;
            }

            showLoading();
            
            try {
                const project = {
                    id: Date.now(),
                    title: title.value,
                    description: description.value,
                    technologies: techs,
                    link: link.value,
                    createdBy: localStorage.getItem('adminUsername'),
                    createdAt: new Date().toISOString()
                };
                
                const projects = JSON.parse(localStorage.getItem('projects') || '[]');
                projects.push(project);
                await new Promise(resolve => setTimeout(resolve, 500)); // Giả lập delay mạng
                localStorage.setItem('projects', JSON.stringify(projects));
                
                projectForm.reset();
                loadProjects();
                alert('Project added successfully!');
            } catch (error) {
                alert('Error adding project: ' + error.message);
            } finally {
                hideLoading();
            }
        });

        async function deleteProject(id) {
            if (confirm('Are you sure you want to delete this project?')) {
                showLoading();
                try {
                    let projects = JSON.parse(localStorage.getItem('projects'));
                    projects = projects.filter(project => project.id !== id);
                    await new Promise(resolve => setTimeout(resolve, 500)); // Giả lập delay mạng
                    localStorage.setItem('projects', JSON.stringify(projects));
                    loadProjects();
                } catch (error) {
                    alert('Error deleting project: ' + error.message);
                } finally {
                    hideLoading();
                }
            }
        }

        // Hàm đăng xuất
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('lastLogin');
                localStorage.removeItem('adminUsername');
                window.location.href = '../index.html';
            }
        }

        // Hiển thị loading khi thực hiện các thao tác
        function showLoading() {
            document.getElementById('loadingSpinner').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').classList.remove('active');
        }

        // Character counter for description
        const description = document.getElementById('description');
        const charCount = document.querySelector('.char-count');
        
        description.addEventListener('input', () => {
            const count = description.value.length;
            charCount.textContent = `${count}/500`;
            
            if (count > 500) {
                description.classList.add('invalid-input');
            } else {
                description.classList.remove('invalid-input');
            }
        });

        // Technology tags preview
        const techInput = document.getElementById('technologies');
        const techPreview = document.querySelector('.tech-preview');

        techInput.addEventListener('input', () => {
            const techs = techInput.value.split(',').map(t => t.trim()).filter(t => t);
            techPreview.innerHTML = techs.map(tech => 
                `<span class="tech-tag">${tech}</span>`
            ).join('');
        });

        // Load projects when page loads
        loadProjects();
    </script>

    <script src="../assets/js/theme.js"></script>
</body>
</html>